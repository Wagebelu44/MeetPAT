window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser."),document.addEventListener("FilePond:loaded",e=>{$("#upload-custom-audience").show(),$(".spinner-loader-filepond").remove()}),$(document).ready(function(){document.querySelector("#audience_name").setCustomValidity("invalid");var e=function(){var e=document.querySelector('input[type="file"]').checkValidity(),i=document.querySelector("#audience_name").checkValidity();e&&i?$("#submit_audience").prop("disabled",!1):$("#submit_audience").prop("disabled",!0)};site_url=window.location.protocol+"//"+window.location.host,FilePond.registerPlugin(FilePondPluginFileValidateType),FilePond.registerPlugin(FilePondPluginFileValidateSize);var i=FilePond.create(document.querySelector('input[type="file"]'));document.querySelector(".filepond--root").addEventListener("FilePond:removefile",i=>{$.post("/api/meetpat-client/large-data/delete?file_id="+$("#fileId").val()+"&user_id="+$("#userId").val(),function(e){}).done(function(i){e()}).fail(function(e){})}),document.querySelector(".filepond--root").addEventListener("FilePond:processfilestart",i=>{$.post("/api/meetpat-client/large-data/delete?file_id="+$("#fileId").val()+"&user_id="+$("#userId").val(),function(e){}).done(function(i){$(".filepond--file-action-button").prop("disabled",!0),e()}).fail(function(e){})}),document.querySelector(".filepond--root").addEventListener("FilePond:processfile",e=>{$(".filepond--file-action-button").prop("disabled",!1)}),document.querySelector(".filepond--root").addEventListener("FilePond:processfilerevert",i=>{$.post("/api/meetpat-client/large-data/delete?file_id="+$("#fileId").val()+"&user_id="+$("#userId").val(),function(e){}).done(function(i){$("#fileCheckerPlaceholder").hide(),e()}).fail(function(e){})}),FilePond.setOptions({maxFileSize:"4MB",required:!0,dropValidation:!0,instantUpload:!1,required:!0,dropOnPage:!0,onaddfile:e=>{$("#no-file").hide(),i.setOptions({disabled:!0}),$("#fileCheckerPlaceholder").show(),$("#fileCheckerPlaceholder .d-flex").html('<strong class="loading">Checking your file</strong><div class="spinner-border spinner-border-sm ml-auto" role="status" aria-hidden="true"></div>'),$.get("/api/meetpat-client/large-data/uploads-available",{user_id:$("#userId").val(),api_token:$("#authToken").val()},e=>{function l(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}var t={delimiter:"",newline:"",quoteChar:'"',escapeChar:'"',header:!1,transformHeader:void 0,dynamicTyping:!1,preview:0,encoding:"",worker:!1,comments:!1,step:void 0,complete:function(t){if(i.setOptions({disabled:!1}),console.log(t),"csv"==i.getFile().file.name.split(".")[1])if(";"==t.meta.delimiter)if(d=t.data[0],r=["FirstName","Surname","MobilePhone","Email","IDNumber","CustomVar1"],d&&r&&!(d<r||r<d))if(uploads_left=e.upload_limit-e.uploads,uploads_left>=t.data.length-1){invalid_rows=[];var a=/^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,})$/,o=/^[a-zA-Z]+(([',. -][a-zA-Z ])?[a-zA-Z]*)*/,s=/^[0-9+]+$/,n=/^[0-9]+$/;for(let e=1;e<t.data.length;e++){const i=t.data[e];6!=i.length?invalid_rows.push(i):""===i[2]&&""===i[3]?invalid_rows.push(i):(o.test(i[0])||""!==i[0]&&(invalid_rows.includes(i)||invalid_rows.push(i)),o.test(i[1])||""!==i[1]&&(invalid_rows.includes(i)||invalid_rows.push(i)),s.test(i[2])||""!==i[2]&&(invalid_rows.includes(i)||invalid_rows.push(i)),a.test(i[3])||""!==i[3]&&(invalid_rows.includes(i)||invalid_rows.push(i)),n.test(i[4])||""!==i[4]&&(invalid_rows.includes(i)||invalid_rows.push(i)),o.test(i[5])||""!==i[5]&&(invalid_rows.includes(i)||invalid_rows.push(i)))}invalid_rows.length?($("#fileCheckerPlaceholder").hide(),i.removeFiles(),$("#no-file").show(),$("#invalid-file").html("<strong>Error!</strong> Audience failed to upload. There are <strong> "+invalid_rows.length+"</strong> bad rows in the file.")):($("#fileCheckerPlaceholder .d-flex").html('<strong>Check complete</strong><div class="ml-auto"><i class="fas text-success fa-check-circle"></i></div>'),i.processFiles())}else $("#fileCheckerPlaceholder").hide(),i.removeFiles(),$("#no-file").show(),$("#invalid-file").html("<strong>Error!</strong> Audience failed to upload. You have <strong>"+l(uploads_left)+"</strong> available. The file you uploaded contains "+l(t.data.length-1)+". Contact your reseller to increase your limit.");else $("#fileCheckerPlaceholder").hide(),i.removeFiles(),$("#no-file").show(),$("#invalid-file").html("<strong>Error!</strong> File does not match template.");else $("#fileCheckerPlaceholder").hide(),i.removeFiles(),$("#no-file").show(),$("#invalid-file").html("<strong>Error!</strong> Please use the semicolon (;) delimiter.");else $("#fileCheckerPlaceholder").hide(),i.removeFiles(),$("#no-file").show(),$("#invalid-file").html("<strong>Error!</strong> File is not a csv.");var d,r},error:void 0,download:!1,downloadRequestHeaders:void 0,downloadRequestBody:void 0,skipEmptyLines:!0,chunk:void 0,fastMode:void 0,beforeFirstChunk:void 0,withCredentials:void 0,transform:void 0,delimitersToGuess:[",","\t","|",";",Papa.RECORD_SEP,Papa.UNIT_SEP]};Papa.parse(i.getFile().file,t);console.log(e)}).fail(e=>{console.log(e)})},server:{url:site_url,process:{url:"/api/meetpat-client/large-data/upload?user_id="+$("#userId").val(),method:"POST",withCredentials:!1,chunkRetryDelays:2,chunkUploads:!0,headers:{},onerror:function(e){console.log(e),$("#submit_audience").prop("disabled",!0)},onload:function(l){console.log(l),l=JSON.parse(l),"csv"!=i.getFile().fileExtension?($("#no-file").show(),i.removeFile()):$("#no-file").hide(),"500"!=l.status?$("#fileId").val(l.file_id):(i.removeFile(),$("#no-file").show(),l.error&&$("#no-file").html(l.error)),e()}}}}),$("form#upload-custom-audience").submit(function(e){e.preventDefault();var i=new FormData(this);$("#submit_audience").prop("disabled",!0),$("#submit_audience").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>&nbsp;Submitting...'),$("#fieldsetId").prop("disabled",!0),$.ajax({url:"/api/meetpat-client/large-data/handler",type:"POST",data:i,success:function(e){"success"==e.status?($("#loader").css("display","none"),$("#submit_audience").html("Done"),$("#alert-section").empty(),$("#alert-section").append('<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Success!</strong> Clients have been uploaded successfully.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div>'),window.location="/meetpat-client/data-visualisation"):($("#audience_name").removeClass("is-valid"),$("#audience_name").addClass("is-invalid"),document.getElementById("audience_name").setCustomValidity("invalid"),$("#submit_audience").prop("disabled",!1),$("#submit_audience").html("Submit"),$("#fieldsetId").prop("disabled",!1),$("#alert-section").empty(),$("#alert-section").append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error!</strong> Clients failed to upload. '+e.message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div>'))},complete:function(e){},error:function(e){$("#submit_audience").prop("disabled",!1),$("#submit_audience").html("Submit"),$("#alert-section").empty(),$("#alert-section").append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error!</strong> Clients failed to upload.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div>'),$("#fieldsetId").prop("disabled",!1)},cache:!1,contentType:!1,processData:!1})}),$("#audience_name").on("change keyup select",function(){$(this).val().match(/^[a-zA-Z 0-9]{2,}$/)?($(this).addClass("is-valid"),$(this).removeClass("is-invalid"),this.setCustomValidity("")):($(this).removeClass("is-valid"),$(this).addClass("is-invalid"),this.setCustomValidity("invalid")),e()})});