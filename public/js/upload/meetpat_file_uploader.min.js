$(document).ready(function(){function e(e,t=2){if(0===e)return"0 Bytes";const o=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(o))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}window.addEventListener("dragover",function(e){(e=e||event).preventDefault()},!1),window.addEventListener("drop",function(e){(e=e||event).preventDefault()},!1);$("#submit_audience").click(function(){document.body.scrollTop=0,document.documentElement.scrollTop=0});var t=function(){$("#browseBtn").off(),$("#browseFile").off(),$("#browseBtn").click(function(){$("#browseFile").click()}),$("#browseFile").on("change",function(e){$(this).val()&&o(e.target.files[0])})},o=function(o){$("#no-file, #file-warning").hide(),$("#drop_zone .fileUploadBox").css("background-color","#fff"),$("#drop_zone").removeClass("no-file-dropped"),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><div class="d-flex justify-content-between file-abort"><div><i class="fas fa-file-csv" style="font-size: 24px;"></i><strong>&nbsp;'+o.name+'</strong></div></div><div class="progress w-100" style="height: 4px;"><div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div><div class="d-flex justify-content-between"><div class="size-progress">0 MB of '+e(o.size)+'</div><div class="upload-progress" style="color: #00A3D9;">Uploading... 0%</div></div></div>'),"csv"==o.name.split(".")[1]?o.size>1e7?($("#drop_zone").addClass("no-file-dropped"),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><strong class="text-center">Drag and drop your file here. <button type="button" id="browseBtn" class="btn btn-link">Browse</button></strong></div>'),t(),$("#no-file").show(),$("#invalid-file").html('<strong><i class="fas fa-exclamation-circle"></i>&nbsp; Error!</strong> File size can\'t be greater than <strong>10MB</strong>. Current file size is <strong>'+e(o.size)+"</strong>")):$.get("/api/get-aws-credentials",{api_token:$("#authToken").val()},function(s){AWS.config.region="us-east-1",AWS.config.update({accessKeyId:s.ACCESS_ID,secretAccessKey:s.SECRET_KEY}),AWS.config.credentials.get(function(){new AWS.S3({apiVersion:"2006-03-01",params:{Bucket:"meetpat.fileuploads"}})});o.name;var a=function(e){for(var t=[],o=0;o<=15;o++)t[o]=o.toString(16);var n="";for(o=1;o<=36;o++)n+=15===o?4:20===o?t[4*Math.random()|8]:t[16*Math.random()|0];return e&&(n=n.substring(0,e)),n}(13),i=a+".csv",l=new AWS.S3.ManagedUpload({params:{Bucket:"meetpat.fileuploads",Key:"new_files/"+i,Body:o,ACL:"public-read"}});$("#drop_zone .fileUploadBox .file-abort").append('<div class="cancelUpload"><i class="text-danger fas fa-times-circle"></i></div>'),$(".cancelUpload").click(function(){$("#submit_audience").prop("disabled",!0),$("#fileId").val(""),$("#drop_zone .fileUploadBox .progress-bar").addClass("bg-danger"),l.abort()}),l.on("httpUploadProgress",function(t){percentage=Math.round(t.loaded/t.total*100,2),$("#drop_zone .fileUploadBox .progress-bar").width(percentage.toString()+"%"),$("#drop_zone .fileUploadBox .progress-bar").attr("aria-valuenow",percentage),$("#drop_zone .fileUploadBox .size-progress").html(e(t.loaded)+" of "+e(t.total)),t.loaded==t.total?$("#drop_zone .fileUploadBox .upload-progress").html("99%"):$("#drop_zone .fileUploadBox .upload-progress").html("Uploading... "+percentage+"%")}),l.promise().then(function(e){$("#drop_zone .fileUploadBox .progress-bar").addClass("bg-success"),$("#drop_zone .fileUploadBox .upload-progress").html("100%"),$(".cancelUpload").unbind(),$(".cancelUpload").click(function(){$(".cancelUpload").html('<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>'),n(i,"new_files/")}),function(e){$("#drop_zone .fileUploadBox").css("background-color","#fff"),$("#drop_zone").removeClass("no-file-dropped"),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><div class="d-flex justify-content-between"><strong class="loading">Checking your file</strong><div class="spinner-border spinner-border-sm ml-auto" role="status" aria-hidden="true"></div></div></div>'),$.post("/api/meetpat-client/large-data/check-file",{user_id:$("#userId").val(),uuid:e,api_token:$("#authToken").val()},o=>{const s=setInterval(()=>{$.get("/api/meetpat-client/check-file-job",{api_token:$("#authToken").val(),job_id:o.id},o=>{"error"==o.job.status?(clearInterval(s),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><div class="d-flex justify-content-between"><strong class="loading">Resetting file uploader</strong><div class="spinner-border spinner-border-sm ml-auto" role="status" aria-hidden="true"></div></div></div>'),n(e+".csv","fixed_files/"),t(),$("#no-file").show(),$("#file-warning").hide(),$("#invalid-file").html('<strong><i class="fas fa-exclamation-circle"></i>&nbsp;Error!</strong> '+o.message)):"complete"==o.job.status&&($("#audience_name").val()?$("#submit_audience").prop("disabled",!1):$("#submit_audience").prop("disabled",!0),clearInterval(s),o.job.bad_rows_count&&($("#file-warning").show(),$("#file-warning-feedback").html('<strong><i class="fas fa-exclamation-triangle"></i>&nbsp;Warning</strong> Your file contains <strong>'+function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}(o.job.bad_rows_count)+"</strong> bad rows that will not be submitted.")),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><div class="d-flex justify-content-between"><strong>Check complete</strong><div><i class="fas text-success fa-check-circle"></i>&nbsp;<i class="fas fa-undo-alt"></i></div></div></div>'),$(".fa-undo-alt").unbind(),$(".fa-undo-alt").click(function(){$("#submit_audience").prop("disabled",!0),$("#fileId").val(""),$("#no-file, #file-warning").hide(),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><div class="d-flex justify-content-between"><strong class="loading">Resetting file uploader</strong><div class="spinner-border spinner-border-sm ml-auto" role="status" aria-hidden="true"></div></div></div>'),n(e+".csv","fixed_files/")}))}).fail(e=>{})},5e3)}).fail(e=>{})}(a),$("#fileId").val(a)},function(e){$("#drop_zone .fileUploadBox .progress-bar").addClass("bg-danger"),$("#drop_zone").addClass("no-file-dropped"),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><strong class="text-center">Drag and drop your file here. <button type="button" id="browseBtn" class="btn btn-link">Browse</button></strong></div>'),t()})}).fail(function(e){}):($("#drop_zone").addClass("no-file-dropped"),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><strong class="text-center">Drag and drop your file here. <button type="button" id="browseBtn" class="btn btn-link">Browse</button></strong></div>'),t(),$("#no-file").show(),$("#invalid-file").html('<strong><i class="fas fa-exclamation-circle"></i>&nbsp; Error!</strong> File format is not .csv. Format is .'+o.name.split(".")[1]))},n=function(e,o){$.get("/api/get-aws-credentials",{api_token:$("#authToken").val()},function(n){AWS.config.region="us-east-1",AWS.config.update({accessKeyId:n.ACCESS_ID,secretAccessKey:n.SECRET_KEY}),new AWS.S3({apiVersion:"2006-03-01",params:{Bucket:"meetpat.fileuploads"}}).deleteObject({Bucket:"meetpat.fileuploads",Key:o+e},function(e,o){e||($("#drop_zone").addClass("no-file-dropped"),$("#drop_zone").html('<div class="fileUploadBox d-flex flex-column justify-content-center"><strong class="text-center">Drag and drop your file here. <button type="button" id="browseBtn" class="btn btn-link">Browse</button></strong></div>'),$("#fileId").val(""),t())})}).fail(function(e){})};t(),$("#drop_zone").on("drop",function(e){if($("#no-file, #file-warning").hide(),e.preventDefault(),e.originalEvent.dataTransfer.items&&"file"===e.originalEvent.dataTransfer.items[0].kind){var t=e.originalEvent.dataTransfer.items[0].getAsFile();o(t)}}),$("#drop_zone").on("dragover dragenter",function(e){$("#drop_zone .fileUploadBox").css("background-color","rgba(25, 25, 25, 0.3)"),e.preventDefault()}),$("#drop_zone").on("dragleave dragend",function(){$("#drop_zone .fileUploadBox").css("background-color","rgba(25, 25, 25, 0.1)")}),$("form#upload-custom-audience").submit(function(e){e.preventDefault();var t=new FormData(this);$("#submit_audience").prop("disabled",!0),$("#submit_audience").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>&nbsp;Submitting...'),$("#fieldsetId").prop("disabled",!0),$.ajax({url:"/api/meetpat-client/large-data/handler",type:"POST",data:t,success:function(e){"success"==e.status?($("#loader").css("display","none"),$("#submit_audience").html("Done"),$("#alert-section").empty(),$("#alert-section").append('<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Success!</strong> Clients have been uploaded successfully.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div>'),window.location="/meetpat-client/data-visualisation"):($("#audience_name").removeClass("is-valid"),$("#audience_name").addClass("is-invalid"),document.getElementById("audience_name").setCustomValidity("invalid"),$("#submit_audience").prop("disabled",!1),$("#submit_audience").html("Submit"),$("#fieldsetId").prop("disabled",!1),$("#alert-section").empty(),$("#alert-section").append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error!</strong> Clients failed to upload. '+e.message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div>'))},complete:function(e){},error:function(e){console.log(e),$("#submit_audience").prop("disabled",!1),$("#submit_audience").html("Submit"),$("#alert-section").empty(),$("#alert-section").append('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error!</strong> Clients failed to upload.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div>'),$("#fieldsetId").prop("disabled",!1)},cache:!1,contentType:!1,processData:!1})}),$("#audience_name").on("change keyup select",function(){$(this).val().match(/^[a-zA-Z 0-9]{2,}$/)&&$(this).val()?($("#fileId").val()?$("#submit_audience").prop("disabled",!1):$("#submit_audience").prop("disabled",!0),$(this).addClass("is-valid"),$(this).removeClass("is-invalid"),this.setCustomValidity("")):($(this).removeClass("is-valid"),$(this).addClass("is-invalid"),this.setCustomValidity("invalid"),$("#submit_audience").prop("disabled",!0))})});