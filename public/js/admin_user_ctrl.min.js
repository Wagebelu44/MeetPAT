var get_percentage=function(e,s){return $percentage=s/e*100,Math.trunc($percentage)};function checkForm(e){e.addEventListener("onsubmit",function(e){e?console.log(e):console.log("form submited")})}function validateEmail(e){var s=$(e),a=s.val(),t=s[0].dataset.user;if(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(a).toLowerCase())){s.removeClass("is-invalid"),s.addClass("is-valid"),s[0].setCustomValidity(""),$("#save_changes_uid_"+t).prop("disabled",!1);const e=new XMLHttpRequest,n="/api/meetpat-admin/users/unique-email";e.overrideMimeType("application/json");var i="email="+a+"&user_id="+t;e.open("POST",n,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send(i),e.onload=function(){"true"==JSON.parse(e.responseText).email_used?($(".modal-mesage-container_email_taken_"+t).css("display","block"),s.removeClass("is-valid"),s.addClass("is-invalid"),$("#save_changes_uid_"+t).prop("disabled",!0)):($(".modal-mesage-container_email_taken_"+t).css("display","none"),s.removeClass("is-invalid"),s.addClass("is-valid"),$("#save_changes_uid_"+t).prop("disabled",!1))}}else s.addClass("is-invalid"),s[0].setCustomValidity("email is invalid"),$("#save_changes_uid_"+t).prop("disabled",!0)}function validatePassword(e){var s=$(e),a=s.val(),t=s[0].dataset.user;s.removeClass("is-valid"),s.removeClass("is-invalid"),/^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/.test(String(a))||""==a?(s.removeClass("is-invalid"),s.addClass("is-valid"),s[0].setCustomValidity(""),$("#save_changes_uid_"+t).prop("disabled",!1)):(s.addClass("is-invalid"),s.removeClass("is-valid"),s[0].setCustomValidity("Password is invalid"),$("#save_changes_uid_"+t).prop("disabled",!0))}function validateRequired(e){var s=$(e),a=e.dataset.user;0===s.val().length?(s.addClass("is-invalid"),s.removeClass("is-valid"),s[0].setCustomValidity("field is required"),$("#save_changes_uid_"+a).prop("disabled",!0)):(s.removeClass("is-invalid"),s.addClass("is-valid"),s[0].setCustomValidity(""),$("#save_changes_uid_"+a).prop("disabled",!1))}function generatedPassword(e){var s=$("#PasswordInput_"+e),a=s[0].dataset.user;s.removeClass("is-invalid"),s.addClass("is-valid"),s[0].setCustomValidity(""),$("#save_changes_uid_"+a).prop("disabled",!1)}function change_status(e){$("#loader").css("display","block"),$(".message-container").empty();const s=new XMLHttpRequest;s.overrideMimeType("application/json");var a="user_id="+e.dataset.user;s.open("POST","/api/meetpat-admin/users/active-status-change",!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(a),s.onload=function(){var a=JSON.parse(s.responseText);"client"==a.user_type?($("i",e).removeClass(),0==a.user_was_active?$("i",e).addClass("fas fa-toggle-on"):$("i",e).addClass("fas fa-toggle-off"),$(".message-container").prepend('<div id="AlertBoxTemp" class="alert alert-success alert-dismissible fade show" role="alert">\n                                <strong>Success!</strong> The active status of the selected user has been changed\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>')):$(".message-container").prepend('<div id="AlertBoxTemp" class="alert alert-danger alert-dismissible fade show" role="alert">\n                                <strong>Error!</strong> There is an issue with changing the status of the selected users. Please contact support.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>')},s.onreadystatechange=function(){4===s.readyState&&$("#loader").css("display","none")}}function saveChanges(e){$("#loader").css("display","block"),$(".message-container").empty();const s=new XMLHttpRequest;s.overrideMimeType("application/json");var a,t=$("input[name='user_id'] ",e).val(),i=$("input[name='user_name'] ",e).val(),n=$("input[name='user_email'] ",e).val(),l=$("input[name='new_password'] ",e).val(),d=$("input[name='send_mail'] ",e).is(":checked"),r="user_id="+t+"&user_name="+i+"&user_email="+n+"&new_password="+l+"&send_mail="+d;$("#save_changes_uid_"+t).prop("disabled",!0),$("#save_changes_uid_"+t).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>\n            Saving...'),s.open("POST","/api/meetpat-admin/users/edit",!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onload=function(){a=JSON.parse(s.responseText),console.log(a),"true"==a.email_valid&&"true"==a.user_name_valid?("true"==a.password_change&&"false"==a.password_valid?($("input[name='new_password'] ",e).addClass("is-invalid"),$(".modal-mesage-container_"+a.users_id).css("display","block")):($("#EditUser_"+t).modal("hide"),$("#save_changes_uid_"+t).prop("disabled",!1),$("#save_changes_uid_"+t).html("Save Changes"),$("#clientName__"+t).html(i),$("#userEmail__"+t).html(n)),"true"==a.sent_mail?$(".message-container").prepend('<div id="AlertBoxTemp" class="alert alert-success alert-dismissible fade show" role="alert">\n                                                <strong>Success!</strong> Changes to the selected user has been saved and an email has been sent.\n                                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                                <span aria-hidden="true">&times;</span>\n                                                </button>\n                                                </div>'):$(".message-container").prepend('<div id="AlertBoxTemp" class="alert alert-success alert-dismissible fade show" role="alert">\n                                                <strong>Success!</strong> Changes to the selected user has been saved.\n                                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                                <span aria-hidden="true">&times;</span>\n                                                </button>\n                                                </div>')):$(".modal-mesage-container_"+a.users_id).css("display","block")},s.onreadystatechange=function(){4===s.readyState&&$("#loader").css("display","none")},s.send(r)}function deleteUser(e){$("#loader").css("display","block");var s=e.dataset.user;const a=new XMLHttpRequest;a.overrideMimeType("application/json"),a.open("POST","/api/meetpat-admin/users/delete",!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),params="user_id="+s,a.send(params),a.onload=function(){var e=JSON.parse(a.responseText);$("#DeleteUser__"+s).modal("hide"),$(".message-container").empty(),1==e.deleted?$(".message-container").prepend('<div id="AlertBoxTemp" class="alert alert-success alert-dismissible fade show" role="alert">\n                                                <strong>Success!</strong> The selected user has been deleted.\n                                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                                <span aria-hidden="true">&times;</span>\n                                                </button>\n                                                </div>'):$(".message-container").prepend('<div id="AlertBoxTemp" class="alert alert-danger alert-dismissible fade show" role="alert">\n                                                <strong>Error!</strong> The selected user could not be deleted.\n                                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                                <span aria-hidden="true">&times;</span>\n                                                </button>\n                                                </div>')},a.onreadystatechange=function(){4===a.readyState&&location.reload(!0)}}function viewPassword(e){var s=e.dataset.user,a=$("#PasswordInput_"+s),t=$("i","#ViewPassword_"+s);"password"==a.attr("type")?(a.attr({type:"text"}),t.removeClass(),t.addClass("fas fa-eye-slash")):(a.attr({type:"password"}),t.removeClass(),t.addClass("fas fa-eye"))}function generatePassword(e){var s=e.dataset.user;const a=new XMLHttpRequest;a.overrideMimeType("application/json"),a.open("GET","/api/meetpat-admin/generate-password",!0),a.send(),a.onload=function(){var e=JSON.parse(a.responseText);$("#PasswordInput_"+s).val(e.password),$("#PasswordInput_"+s).removeClass("is-invalid"),$("#PasswordInput_"+s).removeClass("is-valid"),$("#PasswordInput_"+s).addClass("is-valid"),$("#save_changes_uid_"+s).prop("disabled",!1)}}$(document).ready(function(){$.get("/api/meetpat-admin/users",function(){}).done(function(e){e.forEach(function(e){e.audience_files="/meetpat-admin/users/files/"+e.id,e.edit=e.id,e.active={active:e.client.active,user_id:e.id},e.delete=e.id,e.settings=e.id,e.details=e.id,e.user={id:e.id,email:e.email,name:e.name},e.client_uploads?e.uploads={user_id:e.id,uploads_percentage:get_percentage(e.client_uploads.upload_limit,e.client_uploads.uploads),client_upload_limit:e.client_uploads.upload_limit,client_uploads:e.client_uploads.uploads}:e.uploads={user_id:e.id,uploads_percentage:0,client_upload_limit:0,client_uploads:0},$("#clearUploads__"+e.id).click(function(s){$("#clearUploads__"+e.id+" i").addClass("fa-spin"),$.post("/api/meetpat-admin/settings/clear-uploads",{user_id:e.id},function(e){}).fail(function(e){console.log(e)}).done(function(s){"cleared"==s.message?($("#alertSectionSettings__"+e.id).html('<div class="alert alert-success alert-dismissible fade show" role="alert">\n                                <strong>Success</strong>  &mdash; User uploads have been cleared.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>'),$("#userUploadsPercentage__"+e.id).html("0%"),$("#userUploadsPercentage__"+e.id).attr("aria-valuenow",0),$("#userUploadsPercentage__"+e.id).removeAttr("style").css("width","0%")):$("#alertSectionSettings__"+e.id).html('<div class="alert alert-danger alert-dismissible fade show" role="alert">\n                                <strong>Error!</strong>  &mdash; An error has occured please contact support.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>'),$("#clearUploads__"+e.id+" i").removeClass("fa-spin")})}),$("#rmvUsrFrmAffRecs__"+e.id).click(function(){$("#rmvUsrFrmAffRecs__"+e.id+" i").addClass("eraser"),$("#rmvUsrFrmAffRecs__"+e.id).prop("disabled",!0),$.post("/api/meetpat-admin/settings/remove-affiliate",{user_id:e.id},function(e){}).fail(function(s){$("#rmvUsrFrmAffRecs__"+e.id+" i").removeClass("eraser"),$("#rmvUsrFrmAffRecs__"+e.id).prop("disabled",!1),console.log(s)}).done(function(s){"success"==s.message?$("#alertSectionSettings__"+e.id).html('<div class="alert alert-success alert-dismissible fade show" role="alert">\n                                <strong>Success</strong>  &mdash; User has been removed from affiliated records.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>'):$("#alertSectionSettings__"+e.id).html('<div class="alert alert-danger alert-dismissible fade show" role="alert">\n                                <strong>Error!</strong>  &mdash; An error has occured please contact support.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>'),$("#rmvUsrFrmAffRecs__"+e.id+" i").removeClass("eraser"),$("#rmvUsrFrmAffRecs__"+e.id).prop("disabled",!1)})}),$("#updateClientUploadLimit__"+e.id).click(function(){var s=this;$(this).prop("disabled",!0),$(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>\n                       Saving...'),$("#newUploadLimit__"+e.id).val()>=e.client_uploads.uploads?($("#newUploadLimit__"+e.id).removeClass("is-invalid"),$.post("/api/meetpat-admin/settings/updated-upload-limit",{user_id:e.id,new_upload_limit:$("#newUploadLimit__"+e.id).val()},function(e){}).fail(function(a){console.log(a),$(s).prop("disabled",!1),$(s).html("Save"),$("#alertSectionSettings__"+e.id).html('<div class="alert alert-danger alert-dismissible fade show" role="alert">\n                                <strong>Error!</strong>  &mdash; An error has occured please contact support.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>')}).done(function(a){$(s).prop("disabled",!1),$(s).html("Save"),"success"==a.status?($("#alertSectionSettings__"+e.id).html('<div class="alert alert-success alert-dismissible fade show" role="alert">\n                                    <strong>Success!</strong>  &mdash; User upload limit has been updated.\n                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                    <span aria-hidden="true">&times;</span>\n                                    </button>\n                                </div>'),$("#userUploadsPercentage__"+e.id).html(e.uploads.client_uploads+"/"+$("#newUploadLimit__"+e.id).val()),$("#userUploadsPercentage__"+e.id).attr("aria-valuenow",get_percentage($("#newUploadLimit__"+e.id).val(),e.uploads.client_uploads)),$("#userUploadsPercentage__"+e.id).removeAttr("style").css("width",get_percentage($("#newUploadLimit__"+e.id).val(),e.uploads.client_uploads)+"%")):$("#alertSectionSettings__"+e.id).html('<div class="alert alert-danger alert-dismissible fade show" role="alert">\n                                    <strong>Error!</strong>  &mdash; An error has occured please contact support.\n                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                    <span aria-hidden="true">&times;</span>\n                                    </button>\n                                </div>')})):($(s).prop("disabled",!1),$(s).html("Save"),$("#newUploadLimit__"+e.id).addClass("is-invalid"))}),$("#updateClientCreditLimit__"+e.id).click(function(){var s=this;$(this).prop("disabled",!0),$(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>\n                       Saving...'),$.post("/api/meetpat-admin/settings/updated-credit-limit",{user_id:e.id,new_credit_limit:$("#newCreditLimit__"+e.id).val()},function(e){}).fail(function(a){$(s).prop("disabled",!1),$(s).html("Save"),$("#alertSectionSettings__"+e.id).html('<div class="alert alert-danger alert-dismissible fade show" role="alert">\n                            <strong>Error!</strong>  &mdash; An error has occured please contact support.\n                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                            <span aria-hidden="true">&times;</span>\n                            </button>\n                        </div>'),console.log(a)}).done(function(a){$(s).prop("disabled",!1),$(s).html("Save"),"success"==a.status?($("#alertSectionSettings__"+e.id).html('<div class="alert alert-success alert-dismissible fade show" role="alert">\n                                <strong>Success!</strong>  &mdash; User credit limit has been updated.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>'),$("#useCreditPercentage__"+e.id).html(e.similar_audience_credits.used_credits+"/"+$("#newCreditLimit__"+e.id).val()),$("#useCreditPercentage__"+e.id).attr("aria-valuenow",get_percentage($("#newCreditLimit__"+e.id).val(),e.similar_audience_credits.used_credits)),$("#useCreditPercentage__"+e.id).removeAttr("style").css("width",get_percentage($("#newCreditLimit__"+e.id).val(),e.similar_audience_credits.used_credits)+"%")):$("#alertSectionSettings__"+e.id).html('<div class="alert alert-danger alert-dismissible fade show" role="alert">\n                                <strong>Error!</strong>  &mdash; An error has occured please contact support.\n                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                                </button>\n                            </div>')})}),$("#companyInfoEdit__"+e.id).click(function(){$("#saveChangesBtn__"+e.id).removeClass("d-none")}),$("#saveChangesForm__"+e.id+" :input").each(function(){$(this).val()||this.setCustomValidity("Invalid")}),$("#clientFirstName__"+e.id+", #contactFirstName__"+e.id+", #clientLastName__"+e.id+", #contactLastName__"+e.id+", #businessRegisteredName__"+e.id).on("keyup change",function(){$(this).val().match(/^([a-zA-z ]){2,}$/)?(this.setCustomValidity(""),$(this).removeClass("is-invalid"),$(this).addClass("is-valid")):(this.setCustomValidity("Invalid Name"),$(this).removeClass("is-valid"),$(this).addClass("is-invalid"))}),$("#clientPostalAddress__"+e.id+", #businessPostalAddress__"+e.id+", #businessPhysicalAddress__"+e.id).on("keyup change",function(){$(this).val().length<2?(this.setCustomValidity("Invalid Address"),$(this).removeClass("is-valid"),$(this).addClass("is-invalid")):(this.setCustomValidity(""),$(this).removeClass("is-invalid"),$(this).addClass("is-valid"))}),$("#clientContactNumber__"+e.id+", #businessContactNumber__"+e.id).on("keyup change",function(){$(this).val().match(/^(\+27)(\s)(\d){2}(\s)(\d){3}(\s)(\d){4}$/)?(this.setCustomValidity(""),$(this).removeClass("is-invalid"),$(this).addClass("is-valid")):(this.setCustomValidity("Invalid phone number"),$(this).removeClass("is-valid"),$(this).addClass("is-invalid"))}),$("#clientEmailAddress__"+e.id+", #businessEmailAddress__"+e.id).on("keyup change",function(){$(this).val().match(/^[_a-zA-Z0-9-]+(\.[_a-zA-Z0-9-]+)*@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*(\.[a-zA-Z]{2,})$/)?(this.setCustomValidity(""),$(this).removeClass("is-invalid"),$(this).addClass("is-valid")):(this.setCustomValidity("Invalid email address"),$(this).removeClass("is-valid"),$(this).addClass("is-invalid"))}),$("#businessRegistrationNumber__"+e.id).on("keyup change",function(){$(this).val().match(/^[\d]+$/)?(this.setCustomValidity(""),$(this).removeClass("is-invalid"),$(this).addClass("is-valid")):(this.setCustomValidity("Invalid business registration number"),$(this).removeClass("is-valid"),$(this).addClass("is-invalid"))}),$("#businessVatNumber__"+e.id).on("keyup change",function(){$(this).val().match(/^(\d){10}$/)?(this.setCustomValidity(""),$(this).removeClass("is-invalid"),$(this).addClass("is-valid")):(this.setCustomValidity("Invalid VAT number"),$(this).removeClass("is-valid"),$(this).addClass("is-invalid"))});var s=$("input[name=user_id"+e.id+"]").val();$("#saveChangesBtn__"+e.id).click(function(){$("#saveChangesForm"+e.id+" :input").each(function(){this.checkValidity()?($(this).addClass("is-valid"),0):$(this).addClass("is-invalid")});var a=this;$(this).prop("disabled",!0),$(this).html('<span class="spinner-border spinner-border-sm saving-status-loader" role="status" aria-hidden="true"></span>Saving Changes');var t={user_id:s,client_first_name:$("input[name=client_first_name__"+e.id+"]").val(),client_last_name:$("input[name=client_last_name__"+e.id+"]").val(),client_email_address:$("input[name=client_email_address__"+e.id+"]").val(),client_contact_number:$("input[name=client_contact_number__"+e.id+"]").val(),client_postal_address:$("textarea[name=client_postal_address"+e.id+"]").val(),business_registered_name:$("input[name=business_registered_name__"+e.id+"]").val(),contact_first_name:$("input[name=contact_first_name__"+e.id+"]").val(),contact_last_name:$("input[name=contact_last_name__"+e.id+"]").val(),contact_email_address:$("input[name=contact_email_address__"+e.id+"]").val(),business_contact_number:$("input[name=business_contact_number__"+e.id+"]").val(),business_registration_number:$("input[name=business_registration_number__"+e.id+"]").val(),business_vat_number:$("input[name=business_vat_number"+e.id+"]").val(),business_physical_address:$("textarea[name=business_physical_address__"+e.id+"]").val(),business_postal_address:$("textarea[name=business_postal_address__"+e.id+"]").val()};$.post("/api/meetpat-client/settings/save-changes",t,function(e){}).done(function(e){console.log(t),console.log("Updated information"),$(this).html("Save Changes"),$("#saveChangesBtn__"+s).addClassClass("d-none")}).fail(function(e){$(a).prop("disabled",!1),$(a).html("Save Changes"),$("input, textarea").removeClass("is-valid")})})});var s=e;console.log(s);new Tabulator("#users-table",{data:s,layout:"fitDataFill",pagination:"local",paginationSize:12,columns:[{title:"ID",field:"id"},{title:"Name",field:"user",formatter:function(e,s){var a=e.getValue();return'<span id="clientName__'+a.id+'">'+a.name+"</span>"}},{title:"Email",field:"user",formatter:function(e,s){var a=e.getValue();return'<a href="mailto:'+a.email+'?Subject=MeetPat" id="userEmail__'+a.id+'">'+a.email+"</a>"}},{title:"Audience Files",field:"audience_files",align:"center",formatter:function(e,s){e.getValue();return"<a href='"+e.getValue()+"'><i class='fas fa-folder action-link'></i></a>"}},{title:"Edit",field:"edit",align:"center",formatter:function(e,s){e.getValue();return'<button class="edit-tooltip table_button" data-toggle="modal" data-target="#EditUser_'+e.getValue()+'" data-toggle="tooltip" data-html="true" title="edit"><i class="fas fa-pen-alt action-link"></i></button>'}},{title:"Active",field:"active",align:"center",formatter:function(e,s){e.getValue();return e.getValue().active?'<button id="ActiveStatusBtn_'+e.getValue().user_id+'" onclick="change_status(this)" type="submit" class="active-tooltip table_button ActiveStatusBtn" data-toggle="tooltip" data-html="true" title="status" data-user="'+e.getValue().user_id+'"><i class="fas fa-toggle-on action-link"></i></button>':'<button id="ActiveStatusBtn_'+e.getValue().user_id+'" onclick="change_status(this)" type="submit" class="active-tooltip table_button ActiveStatusBtn" data-toggle="tooltip" data-html="true" title="status" data-user="'+e.getValue().user_id+'"><i class="fas fa-toggle-off action-link"></i></button>'}},{title:"Delete",field:"delete",align:"center",formatter:function(e,s){return`<button class="delete-tooltip table_button" data-toggle="modal" data-target="#DeleteUser__${e.getValue()}" data-toggle="tooltip" data-html="true" title="delete">\n                                <i class="far fa-trash-alt action-link"></i>\n                            </button>`}},{title:"Settings",field:"settings",align:"center",formatter:function(e,s){return`<button class="settings-tooltip table_button" data-toggle="modal" data-target="#SettingsUser__${e.getValue()}" data-toggle="tooltip" data-html="true" title="settings">\n                                <i class="fas fa-cogs action-link"></i>\n                            </button>`}},{title:"Company Details",field:"details",align:"center",formatter:function(e,s){return`<button class="settings-tooltip table_button" data-toggle="modal" data-target="#CompanyDetails__${e.getValue()}" data-toggle="tooltip" data-html="true" title="info">\n                                <i class="fas fa-info-circle action-link"></i>\n                            </button>`}}]})}).fail(function(e){console.log(e)})});